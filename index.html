<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>Leaflet</title>
    <link rel="stylesheet" type="text/css" href="//code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
    <link rel="stylesheet" type="text/css" href="//cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous">
        </script>
    <script src="http://code.jquery.com/ui/1.12.0/jquery-ui.js"
        integrity="sha256-0YPKAwZP7Mp3ALMRVB2i8GXeEndvCq3eSl/WsAl1Ryk=" crossorigin="anonymous"></script>


    <style>
        html,
        body {
            width: 100%;
            height: 100%;
        }

        body {
            padding: 0;
            margin: 0;
        }

        .legend {
            line-height: 18px;
            color: #555;
            background-color: #ffffff;
            border-style: solid;
            border-color: black;
            border-width: 1px;
        }

        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 1;
        }


        #time-ranges {
            position: fixed;
            top: 43px;
            left: 50%;
            margin-right: -50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            padding: 1em;
            background: white;
            font-family: Helvetica Neue, Arial, Helvetica, sans-serif;
        }

        #time-ranges input {
            display: inline-block;
            border: 1px solid #999;
            font-size: 14px;
            border-radius: 4px;
            height: 28px;
            line-height: 28px;
        }

        #time-ranges input[type='submit'] {
            box-sizing: content-box;
            padding: 0 1em;
            text-transform: uppercase;
            color: white;
            background: #5C7DB8;
            border-color: #5C7DB8;
        }

        #to select {
            padding: 0 1em;
        }

        #to {
            font-size: 14px;
            height: 30px;
            padding: 0 1em;
            text-transform: uppercase;
        }

        #map_canvas {
            width: 100%;
            height: 100%;
        }

        #time-range {
            position: fixed;
            bottom: 5px;
            width: 50%;
            left: 50%;
            margin-right: -50%;
            z-index: 1000;
            padding: 0 1em 1em 1em;
            background: white;
            transform: translate(-50%, -50%);
        }

        #slider-range {
            z-index: 1000;

        }

        #time-range p {
            font-family: Helvetica Neue, Arial, Helvetica, sans-serif;
            font-size: 14px;
            color: #333;
        }
    </style>

</head>


<body onload="initialize()">
    <div id="map_canvas"></div>
    <div id="time-range" class="leaflet-bar">
        <p><b>Current time:</b> <span class="slider-time"></span> 
        </p>
        <div> <!--also with class="sliders_step1-->
            <div id="slider-range"> <!----works like this:</div>class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all">!-->
                <!----span class="ui-slider-handle ui-state-default ui-corner-all">!-->
            </div>
        </div>
    </div>
        <div id="time-ranges" class="leaflet-bar">
            <form action="#" id="form">
                <label for="from">
                    From
                    <input id="from" type="date" value="2020-01-17" name="from" min="2018-07-07">
                </label>
                <label for="to">
                    <label>Period
                        <select id="to" name="top5">
                            <option value="1">1 Day</option>
                            <option value="2">2 Days</option>
                            <option>3 Days</option>
                            <option>4 Days</option>
                            <option>5 Days</option>
                        </select>
                    </label>
                </label>
                <input type="submit" value="Update">
            </form>
        </div>
        <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
            integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
            crossorigin=""></script>
        <script src="leaflet.rotatedMarker.js"></script>
        <link rel="stylesheet" href="dist/wind-js-leaflet.css" />
        <link rel="stylesheet" href="/demo/demo.css" />
        <script src="/dist/wind-js-leaflet.js"></script>
        <!--leaflet-velocity-->
        <link rel="stylesheet" href="dist/leaflet-velocity.css" />
        <script src="dist/leaflet-velocity.js"></script>
        <link rel="stylesheet" type="text/css" href="//code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />

        <script>
            let timeForm = document.getElementById('form');
            let dateInput = document.getElementById('from');
            let periodInput = document.getElementById('to');
            from.max = new Date().toISOString().split("T")[0];
            from.value = from.max;
            timeForm.addEventListener('submit', function updateTimeRange(e) {
                console.log(dateInput.value);

                let date = new Date(dateInput.value);
                console.log(date);

                let period = periodInput.value;
                console.log(date);
                console.log(period);
                // WindJSLeaflet._clearWind();
                if (velocityLayer != undefined) {
                    layerControl.removeLayer(velocityLayer);
                    map.removeLayer(velocityLayer);
                }
                setupSlider(date, date.getDate + period);
                setupWindApi(layerControl, date);
                //getDustSensorsByDate(date.year, date.month, date.day);
                e.preventDefault();
            });




            const geocodeUrl = 'https://nominatim.openstreetmap.org/search?q=';
            const geocodeParams = '&format=json&limit=1';
            let map = null;

            let windIcon = L.icon({
                iconUrl: 'images/wind.png',
                iconSize: [100, 100], // size of the icon
                iconAnchor: [0, 32],
                popupAnchor: [0, -32]
            });

            let windIcon2 = L.icon({
                iconUrl: 'images/wind-direction.png',
                iconSize: [100, 100], // size of the icon
                iconAnchor: [0, 32],
                popupAnchor: [0, -32]
            });

            function DataObject(id, lat, lon, dust) {
                this.id = id
                this.lat = lat
                this.lon = lon
                this.dust = dust
            }
            let dustsensors;
            let layerControl;
            function initialize() {
                var Esri_WorldImagery = L.tileLayer(
                    "http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
                    {
                        attribution:
                            "Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, " +
                            "AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"
                    }
                );

                let center = L.latLng(48.8, 9.2);
                let zoom = 11;
                map = L.map('map_canvas').setView(center, zoom);
                let osm = new L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
                    minZoom: 2,
                    maxZoom: 18
                });
                map.addLayer(Esri_WorldImagery);

                let dustSensorsPromise = getDustSensorsByDate(2019, 1, 7);

                let background = { "Clear map": osm, Satellite: Esri_WorldImagery };
                let foreground = {};
                layerControl = L.control.layers(background).addTo(map);
                let dao = new DataObject(20144, 50.814, 6.590, 0.82)

                $.getJSON('http://localhost:3000/wind/4928/2020-1-8-16-20', function (data) {
                    console.log(data);

                })


                // L.marker([48.73, 9.2], {
                //     rotationAngle: 45,
                //     icon: windIcon
                // }).addTo(map);


                //pastData(layerControl, timestamp);
                // currentData(layerControl)
                // setInterval(function () {
                //     currentData(layerControl)
                // }, 300000)
                setupSlider()
                let today = new Date().toISOString()
                setupWindApi(layerControl, today)
            }

            function setupSlider() {
                let start = "2020-01-18 00:00:00";
                let range = 5;

                $('.slider-time').html(start);

                let start_date = new Date(start);
                let end_date = start_date;
                end_date.setDate(end_date.getDate() + 5);
                let min_val = new Date(start) / 1000;
                let max_val = end_date / 1000;
                console.log(start_date + "" + end_date);


                $('.slider-time2').html(formatDT(end_date));
                console.log(min_val + " " + max_val);


                function zeroPad(num, places) {
                    var zero = places - num.toString().length + 1;
                    return Array(+(zero > 0 && zero)).join("0") + num;
                }
                function formatDT(fullDate) {
                    var year = fullDate.getFullYear();
                    console.log(fullDate.getMonth() + 1);

                    var month = zeroPad(fullDate.getMonth() + 1, 2);
                    var date = zeroPad(fullDate.getDate(), 2);
                    var hours = zeroPad(fullDate.getHours(), 2);
                    var minutes = zeroPad(fullDate.getMinutes(), 2);
                    var seconds = zeroPad(fullDate.getSeconds(), 2);
                    return year + '-' + month + '-' + date + ' ' + hours + ':' + minutes + ':' + seconds;
                };


                $("#slider-range").slider({
                    range: false,
                    min: min_val,
                    max: max_val,
                    step: 600,
                    values: [min_val],
                    slide: function (e, ui) {
                        var currentDate = new Date(ui.values[0] * 1000); //.format("yyyy-mm-dd hh:ii:ss");
                        console.log(currentDate);

                        $('.slider-time').html(formatDT(currentDate));


                    }
                });
            }

            function addSlider(sensors) {
                console.log(dustsensors);
                var marker1 = L.marker([51.5, -0.09], { time: "2013-01-22 08:42:26+01" });
                var marker2 = L.marker([51.6, -0.09], { time: "2013-01-22 10:00:26+01" });
                var marker3 = L.marker([51.7, -0.09], { time: "2013-01-22 10:03:29+01" });
                layer = L.layerGroup([dustsensors, marker1, marker2])
                //initiate slider, follow = 1 means, show one feature at a time
                sliderControl = L.control.sliderControl({ position: "topright", layer: layer, follow: true });
                map.addControl(sliderControl);//add slider to map
                sliderControl.startSlider();
            }

            async function getDustSensorsByDate(year, month, day) {
                // $.getJSON('http://localhost:3000/dust/all/2018-7-7', function (data) {
                return $.getJSON('http://localhost:3000/dust/all/' + year + "-" + month + "-" + day, function (data) {
                    console.log("received json");
                    return data;
                })
            }
            let velocityLayer;
            function setupWindApi(layerControl, date) {
                // var handleError = function (err) {
                //     console.log('handleError...');
                //     console.log(err);
                // };

                // WindJSLeaflet.init({
                //     localMode: false,
                //     map: map,
                //     layerControl: layerControl,
                //     useNearest: true, //nearest to Time
                //     timeISO: date, //=currentTime
                //     nearestDaysLimit: 3,
                //     displayValues: true,
                //     displayOptions: {
                //         displayPosition: 'bottomleft',
                //         displayEmptyString: 'No wind data'
                //     },
                //     overlayName: 'Wind',
                //     pingUrl: 'http://localhost:7000/alive',        // url to check service availability
                //     latestUrl: 'http://localhost:7000/latest',     // url to get latest data with no required params
                //     nearestUrl: 'http://localhost:7000/nearest',
                //     errorCallback: handleError
                // });
                $.getJSON("http://localhost:7000/nearest?timeIso=" + date + "&searchLimit=3", function (data) {
                    velocityLayer = L.velocityLayer({
                        displayValues: true,
                        displayOptions: {
                            velocityType: "Global Wind",
                            angleConvention: 'bearingCW',
                            displayPosition: "bottomleft",
                            displayEmptyString: "No wind data",
                            speedUnit: 'km/h'
                        },
                        data: data,
                        onAdd: null,          // callback function
                        onRemove: null,       // callback function
                    });

                    layerControl.addOverlay(velocityLayer, "Wind");
                    velocityLayer.addTo(map);
                });
            }

            //Example: http://localhost:7000/nearest?timeIso=2020-01-18T21:17:34.134Z&searchLimit=3


            function currentData(layerControl) {
                $.getJSON('https://data.sensor.community/airrohr/v1/filter/area=48.8,9.2,10', function (data) {
                    console.log(data);
                    let timestamp = data[0].timestamp;
                    dustsensors = L.layerGroup({ timestamp });
                    layerControl.addOverlay(dustsensors, "Feinstaub")
                    data.forEach(element => {
                        let marker = L.marker([element.location.latitude, element.location.longitude], { time: timestamp }).addTo(dustsensors);
                        if (marker !== undefined) {
                            marker.bindPopup("Sensor id: " + element.sensor.id + " timestamp: " + timestamp);
                        }
                        // dustsensors.add({time: "2013-01-22 12:03:29+01"})
                    });
                    setupWindApi(layerControl, timestamp);
                    // let geojson_now = L.geoJson(array, { time: timestamp });
                    // addSlider();
                })
            }

            function pastData(layerControl, time) {
                $.getJSON('http://localhost:3000/dust/all/2020-1-8', function (data) {
                    console.log(data);
                    let hour = time.hour;
                    let minute = time.minute;
                    dustsensors = L.layerGroup();
                    layerControl.addOverlay(dustsensors, "Feinstaub")
                    let number = 140;
                    console.log(data[number][hour][minute]);
                    console.log(data.length);
                    console.log(Object.entries(data));
                    for (let obj of Object.entries(data)) {
                        if (obj[1][hour] != undefined && obj[1][hour][minute] != undefined) {
                            let element = obj[1][hour][minute];
                            console.log(element);
                            let marker = L.marker([element.lat, element.lon], { time: (time.hour + time.minute) }).addTo(dustsensors);
                            if (marker !== undefined) {
                                marker.bindPopup("Sensor p1: " + element.p1 + " p2: " + element.p2 + "<br/> Time: " + time.hour + ":" + time.minute);
                            }
                        }
                    }

                    //setupWindApi(layerControl, timestamp);
                    // let geojson_now = L.geoJson(array, { time: timestamp });


                })
            }




        </script>
        <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
</body>

</html>